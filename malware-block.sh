#!/bin/sh
# Author: redhat27
# This is a my own version of malware-block. I am using @swetoast's source list, but not the ipset generation logic
# This typically takes under a minute to run, and less than 30 seconds for subsequent runs.

blocklists=/jffs/ipset_lists/malware-block.url_list
url=https://gitlab.com/swe_toast/malware-filter/raw/master/malware-filter.list # Thanks to @swetoast for maintaining this list

# Different routers got different iptables and ipset syntax
case $(ipset -v | grep -o "v[4,6]") in
  v6) MATCH_SET='--match-set'; CREATE='n'; DESTROY='destroy'; RESTORE='restore'; ADD='add'; SWAP='swap'; IPHASH='hash:ip'; NETHASH='hash:net'; SETNOTFOUND='name does not exist'
      lsmod | grep -q "xt_set" || for module in ip_set ip_set_hash_net ip_set_hash_ip xt_set; do
        modprobe $module
      done;;
  v4) MATCH_SET='--set'; CREATE='-N'; DESTROY='--destroy'; RESTORE='--restore'; ADD='-A'; SWAP='--swap'; IPHASH='iphash'; NETHASH='nethash'; SETNOTFOUND='Unknown set'
      lsmod | grep -q "ipt_set" || for module in ip_set ip_set_nethash ip_set_iphash ipt_set; do
        modprobe $module
      done;;
  *) logger -t Firewall "$0: Unknown ipset version. Exiting." && exit 1;;
esac

[ ! -f $blocklists ] &&  wget -q $url --no-check-certificate -O $blocklists
logger -t Firewall "$0: Adding ipset rules to firewall..."
ipset $SWAP MalwareBlockIP MalwareBlockIP 2>&1 | grep -q "$SETNOTFOUND" && ipset $CREATE MalwareBlockIP $IPHASH
ipset $SWAP MalwareBlockCIDR MalwareBlockCIDR 2>&1 | grep -q "$SETNOTFOUND" && ipset $CREATE MalwareBlockCIDR $NETHASH
ipset $DESTROY tIP &>/dev/null; ipset $DESTROY tCIDR &>/dev/null
((
  echo "$CREATE tIP $IPHASH"
  wget -i $blocklists -qO- | sed -n "s/\r//;/^$/d;/^[0-9,\.]*$/s/^/$ADD tIP /p" | sort -u
  echo "COMMIT"
) | nice -n 15 ipset $RESTORE) &
((
  echo "$CREATE tCIDR $NETHASH"
  wget -i $blocklists -qO- | sed -n "s/\r//;/^$/d;/^[0-9,\.,\/]*$/s/^/$ADD tCIDR /p" | grep "/" | sort -u
  echo "COMMIT"
) | nice -n 15 ipset $RESTORE) &
wait
ipset $SWAP tIP MalwareBlockIP && ipset $SWAP tCIDR MalwareBlockCIDR
ipset $DESTROY tIP && ipset $DESTROY tCIDR
iptables-save | grep -q MalwareBlockIP || iptables -I INPUT -m set $MATCH_SET MalwareBlockIP src -j DROP
iptables-save | grep -q MalwareBlockCIDR || iptables -I INPUT -m set $MATCH_SET MalwareBlockCIDR src -j DROP
logger -t Firewall "$0: Loaded ip addresses to MalwareBlockIP ($(expr $(ipset -L MalwareBlockIP | wc -l) - 6)) and MalwareBlockCIDR ($(expr $(ipset -L MalwareBlockCIDR | wc -l) - 6)) sets."
