#!/bin/sh
# Author: redhat27
# snbforums thread: https://www.snbforums.com/threads/yet-another-malware-block-script-using-ipset-v4-and-v6.38935/

urllists=/jffs/ipset_lists/ya-malware-block.url_list # Change to an appropriate download location if needed
giturl=https://raw.githubusercontent.com/shounak-de/misc-scripts/master/ya-malware-block.url_list

# Different routers got different iptables and ipset syntax
case $(ipset -v | grep -o "v[4,6]") in
  v6) MATCH_SET='--match-set'; CREATE='n'; DESTROY='destroy'; RESTORE='restore'; ADD='add'; SWAP='swap'; IPHASH='hash:ip'; NETHASH='hash:net'; SETNOTFOUND='name does not exist'
      lsmod | grep -q "xt_set" || for module in ip_set ip_set_hash_net ip_set_hash_ip xt_set; do
        modprobe $module
      done;;
  v4) MATCH_SET='--set'; CREATE='-N'; DESTROY='--destroy'; RESTORE='--restore'; ADD='-A'; SWAP='--swap'; IPHASH='iphash'; NETHASH='nethash'; SETNOTFOUND='Unknown set'
      lsmod | grep -q "ipt_set" || for module in ip_set ip_set_nethash ip_set_iphash ipt_set; do
        modprobe $module
      done;;
  *) logger -t Firewall "$0: Unknown ipset version. Exiting." && exit 1;;
esac
[ -f "/jffs/scripts/firewall" ] && echo "IPSet_ASUS by @adamm detected, please use that instead." && exit 2
[ -f "/jffs/scripts/malware-filter" ] && echo "Malware-filter by @swetoast detected, please use that instead." && exit 3
[ ! -d $(dirname $urllists) ] && mkdir -p $(dirname $urllists)
[ ! -f $urllists ] &&  wget -q $giturl --no-check-certificate -O $urllists
logger -t Firewall "$0: Adding malware-block rules to firewall..." && [ -t 1 ] && echo "$0: Adding malware-block rules to firewall..."
ipset $SWAP YAMalwareBlockIP YAMalwareBlockIP 2>&1 | grep -q "$SETNOTFOUND" && ipset $CREATE YAMalwareBlockIP $IPHASH
ipset $SWAP YAMalwareBlockCIDR YAMalwareBlockCIDR 2>&1 | grep -q "$SETNOTFOUND" && ipset $CREATE YAMalwareBlockCIDR $NETHASH
ipset $DESTROY tIP &>/dev/null; ipset $DESTROY tCIDR &>/dev/null
((
  echo "$CREATE tIP $IPHASH"
  wget -i $urllists -qO- | sed -n "s/\r//;/^$/d;/^[0-9,\.]*$/s/^/$ADD tIP /p" | sort -u
  echo "COMMIT"
) | nice -n 15 ipset $RESTORE) &
((
  echo "$CREATE tCIDR $NETHASH"
  wget -i $urllists -qO- | sed -n "s/\r//;/^$/d;/^[0-9,\.,\/]*$/s/^/$ADD tCIDR /p" | grep "/" | sort -u
  echo "COMMIT"
) | nice -n 15 ipset $RESTORE) &
wait
ipset $SWAP tIP YAMalwareBlockIP && ipset $SWAP tCIDR YAMalwareBlockCIDR
ipset $DESTROY tIP && ipset $DESTROY tCIDR
iptables-save | grep -q YAMalwareBlockIP || iptables -I FORWARD -m set $MATCH_SET YAMalwareBlockIP src -j DROP
iptables-save | grep -q YAMalwareBlockCIDR || iptables -I FORWARD -m set $MATCH_SET YAMalwareBlockCIDR src -j DROP
FinalMessage="$0: Loaded ip addresses to YAMalwareBlockIP ($(expr $(ipset -L YAMalwareBlockIP | wc -l) - 6)) and YAMalwareBlockCIDR ($(expr $(ipset -L YAMalwareBlockCIDR | wc -l) - 6)) sets."
logger -t Firewall $FinalMessage && [ -t 1 ] && echo $FinalMessage
