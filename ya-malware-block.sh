#!/bin/sh
# Author: redhat27, Version 1.6
# snbforums thread: https://www.snbforums.com/threads/yet-another-malware-block-script-using-ipset-v4-and-v6.38935/

urllists=/jffs/ipset_lists/ya-malware-block.url_list # Change to an appropriate download location if needed
giturl=https://raw.githubusercontent.com/shounak-de/misc-scripts/master/ya-malware-block.url_list

case $(ipset -v | grep -o "v[4,6]") in
  v6) MATCH_SET='--match-set'; CREATE='n'; DESTROY='destroy'; RESTORE='restore'; ADD='add'; SWAP='swap'; IPHASH='hash:ip'; NETHASH='hash:net'; ESL=7
      lsmod | grep -q "xt_set" || for module in ip_set ip_set_hash_net ip_set_hash_ip xt_set; do modprobe $module; done;;
  v4) MATCH_SET='--set'; CREATE='-N'; DESTROY='--destroy'; RESTORE='--restore'; ADD='-A'; SWAP='--swap'; IPHASH='iphash'; NETHASH='nethash'; ESL=6
      lsmod | grep -q "ipt_set" || for module in ip_set ip_set_nethash ip_set_iphash ipt_set; do modprobe $module; done;;
  *) logger -t Firewall "$0: Unknown ipset version. Exiting." && exit 1;;
esac
startTS=$(date +%s); logger -t Firewall "$0: Adding ya-malware-block rules to firewall..." && [ -t 1 ] && echo "$0: Adding ya-malware-block rules to firewall..."
[ ! -d $(dirname $urllists) ] && mkdir -p $(dirname $urllists)
[ ! -f $urllists ] && wget -q $giturl --no-check-certificate -O $urllists
for SetID in 1IP 2IP 3IP CIDR; do [ ${SetID} = "CIDR" ] && ipset -q $CREATE YAMalwareBlock${SetID} $NETHASH || ipset -q $CREATE YAMalwareBlock${SetID} $IPHASH; done
nice -n 15 wget -i $urllists -qO- | nice -n 15 sed -n "s/\r//;/^$/d;/^[0-9,\.,\/]*$/p" | nice -n 15 grep -vE '(^127\.)|(^10\.)|(^172\.1[6-9]\.)|(^172\.2[0-9]\.)|(^172\.3[0-1]\.)|(^192\.168\.)|(^0.)|(^169\.254\.)' | nice -n 15 awk '!a[$0]++' >/tmp/ya-malware-block.sources
ipset -q $DESTROY tSet; (echo "$CREATE tSet $IPHASH"; sed -n "/\//!p" /tmp/ya-malware-block.sources | sed -n "1,65535 s/^/$ADD tSet /p"; echo "COMMIT") | nice -n 15 ipset $RESTORE && ipset $SWAP tSet YAMalwareBlock1IP
ipset -q $DESTROY tSet; (echo "$CREATE tSet $IPHASH"; sed -n "/\//!p" /tmp/ya-malware-block.sources | sed -n "65536,131071 s/^/$ADD tSet /p"; echo "COMMIT") | nice -n 15 ipset $RESTORE && ipset $SWAP tSet YAMalwareBlock2IP
ipset -q $DESTROY tSet; (echo "$CREATE tSet $IPHASH"; sed -n "/\//!p" /tmp/ya-malware-block.sources | sed -n "131072,$ s/^/$ADD tSet /p"; echo "COMMIT") | nice -n 15 ipset $RESTORE && ipset $SWAP tSet YAMalwareBlock3IP
ipset -q $DESTROY tSet; (echo "$CREATE tSet $NETHASH"; sed -n "/\//s/^/$ADD tSet /p" /tmp/ya-malware-block.sources; echo "COMMIT") | nice -n 15 ipset $RESTORE && ipset $SWAP tSet YAMalwareBlockCIDR
ipset $DESTROY tSet; rm /tmp/ya-malware-block.sources
for SetID in CIDR 3IP 2IP 1IP; do iptables-save | grep -q YAMalwareBlock${SetID} || iptables -t raw -I PREROUTING -m set $MATCH_SET YAMalwareBlock${SetID} src -j DROP; done
FinalMessage="$0: Loaded sets YAMalwareBlock1IP ($(expr $(ipset -L YAMalwareBlock1IP | wc -l) - $ESL)), YAMalwareBlock2IP ($(expr $(ipset -L YAMalwareBlock2IP | wc -l) - $ESL)), YAMalwareBlock3IP ($(expr $(ipset -L YAMalwareBlock3IP | wc -l) - $ESL)) and YAMalwareBlockCIDR ($(expr $(ipset -L YAMalwareBlockCIDR | wc -l) - $ESL)) in $(expr $(date +%s) - $startTS) seconds"
logger -t Firewall $FinalMessage && [ -t 1 ] && echo $FinalMessage
